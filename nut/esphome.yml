esphome:
  name: ups-monitor
  friendly_name: UPS Monitor & Control
  platformio_options:
    board_build.f_cpu: 160000000L

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "UPS-Monitor Fallback"
    password: "FallbackPass123"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: "ota_password_123"

logger:
  level: INFO

# ============================================
# –î–ê–¢–ß–ò–ö –ù–ê–õ–ò–ß–ò–Ø –°–ï–¢–ò 220V
# ============================================
binary_sensor:
  - platform: gpio
    pin: GPIO9
    name: "Power Grid 220V"
    id: grid_power
    device_class: power
    icon: mdi:transmission-tower
    filters:
      - delayed_on: 100ms
      - delayed_off: 100ms
    on_press:
      then:
        - logger.log: "‚úÖ –°–µ—Ç—å 220V –ü–û–Ø–í–ò–õ–ê–°–¨"
        - script.execute: handle_power_restored
    on_release:
      then:
        - logger.log: "‚ùå –°–µ—Ç—å 220V –ü–†–û–ü–ê–õ–ê"
        - script.execute: handle_power_loss

# ============================================
# –†–ï–õ–ï –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ë–ü (—ç–º—É–ª—è—Ü–∏—è –∫–Ω–æ–ø–∫–∏)
# ============================================
switch:
  - platform: gpio
    pin: GPIO8
    name: "UPS Power Button"
    id: ups_relay
    icon: mdi:power
    restore_mode: ALWAYS_OFF  # –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–ª–µ –≤—ã–∫–ª—é—á–µ–Ω–æ
    interlock: []  # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ä–µ–ª–µ –¥–ª—è –≤–∑–∞–∏–º–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

# ============================================
# –°–¶–ï–ù–ê–†–ò–ò (SCRIPTS)
# ============================================
script:
  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Å–µ—Ç–∏
  - id: handle_power_loss
    then:
      - delay: 2s  # –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã (–≤–¥—Ä—É–≥ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫–∞—á–æ–∫)
      - if:
          condition:
            binary_sensor.is_off: grid_power
          then:
            - logger.log: "üîã –°–µ—Ç—å –ø—Ä–æ–ø–∞–ª–∞ –Ω–∞–¥–æ–ª–≥–æ, –≤–∫–ª—é—á–∞–µ–º –ò–ë–ü..."
            - script.execute: press_ups_button

  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∏
  - id: handle_power_restored
    then:
      - logger.log: "üîå –°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å"
      - sensor.publish:
          id: last_power_restore
          state: !lambda 'return id(sntp_time).now().timestamp;'

  # –≠–º—É–ª—è—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –ò–ë–ü (3 —Å–µ–∫—É–Ω–¥—ã)
  - id: press_ups_button
    then:
      - logger.log: "üîò –ù–ê–ñ–ò–ú–ê–ï–ú –∫–Ω–æ–ø–∫—É –ò–ë–ü –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã..."
      - switch.turn_on: ups_relay
      - delay: 3s  # –î–µ—Ä–∂–∏–º –∫–Ω–æ–ø–∫—É –Ω–∞–∂–∞—Ç–æ–π 3 —Å–µ–∫—É–Ω–¥—ã
      - switch.turn_off: ups_relay
      - logger.log: "‚úÖ –ö–Ω–æ–ø–∫–∞ –ò–ë–ü –æ—Ç–ø—É—â–µ–Ω–∞"

# ============================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–ï–ù–°–û–†–´
# ============================================
sensor:
  - platform: uptime
    name: "UPS Monitor Uptime"
    update_interval: 60s

  - platform: template
    name: "Last Power Restore"
    id: last_power_restore
    device_class: timestamp
    accuracy_decimals: 0

# –¢–µ–∫—Å—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
text_sensor:
  - platform: template
    name: "UPS Status"
    id: ups_status_text
    lambda: |-
      if (id(grid_power).state) {
        return {" –°–µ—Ç—å –µ—Å—Ç—å"};
      } else {
        return {"üîã –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç –ò–ë–ü"};
      }
    update_interval: 5s

# –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
button:
  - platform: restart
    name: "Restart UPS Monitor"

  - platform: template
    name: "Manual UPS Power On"
    on_press:
      then:
        - script.execute: press_ups_button